<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>The Signpost Observatory - VR Gateway</title>
    <meta name="description" content="A VR gateway to explore ideas, education, and the future">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            background: #0a0a0a;
        }
        
        .ui-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #e0e0e0;
            font-size: 14px;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
        }
        
        .ui-overlay h3 {
            margin: 0 0 10px 0;
            color: #ffffff;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ccc;
            text-align: center;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="ui-overlay">
        <h3>The Signpost Observatory</h3>
        <p>"All we can be now is the signposts for tomorrow and those that come after"</p>
        <p>Navigate through spaces that explore the intersection of technology, education, and human connection.</p>
    </div>
    
    <div class="controls">
        <p>WASD to move • Mouse to look • Click on glowing portals to enter projects</p>
    </div>
    
    <div id="fallback-message" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0,0,0,0.8);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 2000;
    ">
        <h3>Loading VR Environment...</h3>
        <p>If you don't see the 3D environment, please check:</p>
        <ul style="text-align: left;">
            <li>Your browser supports WebGL</li>
            <li>JavaScript is enabled</li>
            <li>You're using a modern browser (Chrome/Firefox)</li>
        </ul>
        <p><small>Check browser console for errors</small></p>
    </div>

    <a-scene 
        vr-mode-ui="enabled: true" 
        embedded 
        style="height: 100vh; width: 100vw;"
        background="color: #001122"
        fog="type: exponential; color: #001122; density: 0.0025"
        loading-screen="enabled: false">
        
        <!-- Assets -->
        <a-assets>
            <!-- Sounds -->
            <audio id="ambient-sound" src="" preload="auto" loop></audio>
            <audio id="portal-hum" src="" preload="auto" loop></audio>
            
            <!-- Materials -->
            <a-mixin id="portal-material" 
                material="color: #00ffaa; emissive: #003322; shader: standard; metalness: 0.1; roughness: 0.3"
                animation="property: material.emissive; to: #006644; dur: 2000; dir: alternate; loop: true"></a-mixin>
                
            <a-mixin id="signpost-text"
                text="color: #ffffff; font: dejavu; align: center; width: 8"
                position="0 0 0.1"></a-mixin>
        </a-assets>

        <!-- Environment -->
        <!-- Ground plane with subtle grid -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="200" 
            height="200" 
            material="color: #001a33; opacity: 0.8; transparent: true"
            geometry="primitive: plane; segmentsWidth: 20; segmentsHeight: 20">
        </a-plane>
        
        <!-- Central observatory platform -->
        <a-cylinder 
            position="0 0.1 0" 
            radius="8" 
            height="0.2" 
            material="color: #003366; metalness: 0.3; roughness: 0.7">
        </a-cylinder>
        
        <!-- Central pillar with the main quote -->
        <a-cylinder 
            position="0 0.2 0" 
            radius="0.3" 
            height="3" 
            material="color: #004488; metalness: 0.5; roughness: 0.5">
        </a-cylinder>
        
        <a-text
            position="0 2.5 0"
            rotation="0 0 0"
            text="value: The Signpost Observatory; color: #ffffff; font: dejavu; align: center; width: 12"
            animation="property: rotation; to: 0 360 0; dur: 30000; loop: true">
        </a-text>
        
        <!-- Project Portal 1: AI & Education -->
        <a-box 
            id="portal-education"
            position="5 1 5" 
            width="2" 
            height="3" 
            depth="0.3"
            mixin="portal-material"
            class="portal"
            data-project="education">
            
            <a-text
                mixin="signpost-text"
                text="value: AI & Education\nInteractive Learning\nFutures; align: center"
                position="0 0 0.2">
            </a-text>
        </a-box>
        
        <!-- Floating elements around education portal -->
        <a-sphere position="4 2.5 4" radius="0.1" material="color: #00aa66; emissive: #003311"
                 animation="property: position; to: 6 3.5 6; dur: 3000; dir: alternate; loop: true"></a-sphere>
        <a-sphere position="6 2.2 4" radius="0.08" material="color: #0088aa; emissive: #002233"
                 animation="property: position; to: 4 3.2 6; dur: 4000; dir: alternate; loop: true"></a-sphere>

        <!-- Project Portal 2: Democracy & Technology -->
        <a-box 
            id="portal-democracy"
            position="-5 1 5" 
            width="2" 
            height="3" 
            depth="0.3"
            mixin="portal-material"
            class="portal"
            data-project="democracy">
            
            <a-text
                mixin="signpost-text"
                text="value: Democracy &\nTechnology\nCritical Analysis; align: center"
                position="0 0 0.2">
            </a-text>
        </a-box>
        
        <!-- Project Portal 3: Human Connection -->
        <a-box 
            id="portal-connection"
            position="0 1 8" 
            width="2" 
            height="3" 
            depth="0.3"
            mixin="portal-material"
            class="portal"
            data-project="connection">
            
            <a-text
                mixin="signpost-text"
                text="value: Human Connection\nEmpathy & AI\nPhilosophical Inquiry; align: center"
                position="0 0 0.2">
            </a-text>
        </a-box>

        <!-- Project Portal 4: Data & Analysis -->
        <a-box 
            id="portal-analysis"
            position="-5 1 -3" 
            width="2" 
            height="3" 
            depth="0.3"
            mixin="portal-material"
            class="portal"
            data-project="analysis">
            
            <a-text
                mixin="signpost-text"
                text="value: Data Visualization\nCrime Analytics\nUrban Studies; align: center"
                position="0 0 0.2">
            </a-text>
        </a-box>

        <!-- Atmospheric elements -->
        <!-- Floating quote fragments -->
        <a-text
            position="10 4 -10"
            rotation="0 45 0"
            text="value: 'signposts for tomorrow'; color: #4488aa; font: dejavu; width: 6; opacity: 0.7"
            animation="property: position; to: 12 5 -8; dur: 8000; dir: alternate; loop: true">
        </a-text>
        
        <a-text
            position="-8 3.5 8"
            rotation="0 -30 0"
            text="value: 'those that come after'; color: #66aacc; font: dejavu; width: 6; opacity: 0.6"
            animation="property: position; to: -10 4.5 10; dur: 10000; dir: alternate; loop: true">
        </a-text>

        <!-- Distant mountains/horizon -->
        <a-triangle 
            position="30 5 -30" 
            scale="20 8 1"
            material="color: #002244; opacity: 0.6; transparent: true">
        </a-triangle>
        
        <a-triangle 
            position="-25 4 -35" 
            scale="15 6 1"
            material="color: #001133; opacity: 0.7; transparent: true">
        </a-triangle>

        <!-- Test cube to verify 3D rendering -->
        <a-box position="0 1 0" color="red" width="1" height="1" depth="1"></a-box>
        
        <!-- Lighting -->
        <a-light type="ambient" intensity="0.3" color="#002244"></a-light>
        <a-light type="directional" position="0 10 5" intensity="0.5" color="#4488cc"></a-light>
        <a-light type="point" position="0 3 0" intensity="0.8" color="#66aaff"></a-light>

        <!-- Camera with WASD controls -->
        <a-entity 
            id="rig" 
            movement-controls="fly: false; speed: 0.1">
            <a-camera 
                look-controls="pointerLockEnabled: true"
                wasd-controls="acceleration: 15"
                position="0 1.6 3"
                cursor="fuse: false; rayOrigin: mouse">
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // Debug logging
        console.log('Signpost Observatory: Script loading...');
        
        // Portal interaction system with backend integration
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Signpost Observatory: DOM loaded');
            
            const portals = document.querySelectorAll('.portal');
            console.log('Signpost Observatory: Found', portals.length, 'portals');
            
            // Load portal data from backend
            loadPortalData();
            
            portals.forEach(portal => {
                console.log('Signpost Observatory: Setting up portal:', portal.getAttribute('data-project'));
                
                portal.addEventListener('click', function() {
                    const project = this.getAttribute('data-project');
                    console.log('Signpost Observatory: Portal clicked:', project);
                    handlePortalClick(project);
                });
                
                // Hover effects
                portal.addEventListener('mouseenter', function() {
                    this.setAttribute('animation__hover', 'property: scale; to: 1.1 1.1 1.1; dur: 300');
                });
                
                portal.addEventListener('mouseleave', function() {
                    this.setAttribute('animation__hover', 'property: scale; to: 1 1 1; dur: 300');
                });
            });
        });
        
        // A-Frame scene loaded event
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            const fallbackMessage = document.getElementById('fallback-message');
            
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('Signpost Observatory: A-Frame scene loaded successfully');
                    fallbackMessage.style.display = 'none';
                    
                    // Debug: Check if elements are visible
                    const testCube = document.querySelector('a-box[color="red"]');
                    const portals = document.querySelectorAll('.portal');
                    console.log('Signpost Observatory: Test cube found:', !!testCube);
                    console.log('Signpost Observatory: Portals found:', portals.length);
                    
                    // Add a visible indicator if scene loads
                    const successIndicator = document.createElement('div');
                    successIndicator.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: green;
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        z-index: 1000;
                    `;
                    successIndicator.textContent = '✅ 3D Scene Loaded';
                    document.body.appendChild(successIndicator);
                });
                
                scene.addEventListener('error', function(error) {
                    console.error('Signpost Observatory: A-Frame scene error:', error);
                    fallbackMessage.style.display = 'block';
                });
                
                // Timeout to show fallback if scene doesn't load
                setTimeout(function() {
                    if (!scene.hasLoaded) {
                        console.warn('Signpost Observatory: A-Frame scene taking too long to load');
                        fallbackMessage.style.display = 'block';
                    }
                }, 5000);
            } else {
                console.error('Signpost Observatory: No a-scene found!');
                fallbackMessage.style.display = 'block';
            }
        });
        
        async function loadPortalData() {
            try {
                const response = await fetch('/api/portals');
                const portals = await response.json();
                console.log('Loaded portal data:', portals);
            } catch (error) {
                console.error('Error loading portal data:', error);
            }
        }
        
        async function handlePortalClick(project) {
            console.log(`Entering ${project} project`);
            
            try {
                const response = await fetch(`/api/projects/${project}`);
                const projectData = await response.json();
                
                showProjectModal(projectData);
            } catch (error) {
                console.error('Error loading project data:', error);
                // Fallback to static descriptions
                const descriptions = {
                    'education': 'Future: Interactive AI tutoring systems, virtual classrooms with adaptive learning environments, and tools for addressing the education pipeline collapse.',
                    'democracy': 'Future: Simulations of democratic processes, visualization of political data, and interactive explorations of the threats to democratic norms.',
                    'connection': 'Future: VR experiences exploring human-AI empathy, virtual therapy environments, and philosophical spaces for contemplating consciousness.',
                    'analysis': 'Future: 3D data visualization spaces, crime mapping interfaces, and interactive urban planning tools based on your analytical work.'
                };
                
                showProjectModal({
                    title: `${project.toUpperCase()} Portal`,
                    description: descriptions[project] || 'Project details coming soon...',
                    status: 'in-development'
                });
            }
        }
        
        function showProjectModal(projectData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(10px);
            `;
            
            const isComingSoon = projectData.status === 'coming-soon' || projectData.status === 'in-development';
            const statusColor = isComingSoon ? '#ffaa00' : '#00ffaa';
            const statusIcon = isComingSoon ? '⏳' : '🚀';
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #001122 0%, #003366 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 20px;
                    max-width: 600px;
                    text-align: center;
                    border: 3px solid ${statusColor};
                    box-shadow: 0 0 40px rgba(0,255,170,0.4);
                    animation: modalPulse 2s ease-in-out infinite alternate;
                ">
                    <div style="font-size: 48px; margin-bottom: 20px;">${statusIcon}</div>
                    <h2 style="color: ${statusColor}; margin-bottom: 20px; font-size: 28px;">${projectData.title}</h2>
                    
                    ${isComingSoon ? `
                        <div style="
                            background: rgba(255,170,0,0.1);
                            border: 1px solid #ffaa00;
                            border-radius: 10px;
                            padding: 20px;
                            margin: 20px 0;
                        ">
                            <h3 style="color: #ffaa00; margin-bottom: 15px; font-size: 24px;">🚧 Coming Soon 🚧</h3>
                            <p style="color: #ffcc66; font-size: 16px; line-height: 1.6;">
                                This immersive VR experience is currently under development. 
                                We're crafting something extraordinary for you.
                            </p>
                        </div>
                    ` : ''}
                    
                    <p style="line-height: 1.8; margin-bottom: 25px; font-size: 16px; color: #e0e0e0;">
                        ${projectData.description}
                    </p>
                    
                    ${projectData.features ? `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #4488cc; margin-bottom: 15px;">✨ Planned Features:</h4>
                            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                                ${projectData.features.map(feature => `
                                    <span style="
                                        background: rgba(68,136,204,0.2);
                                        border: 1px solid #4488cc;
                                        border-radius: 20px;
                                        padding: 8px 16px;
                                        font-size: 14px;
                                        color: #66aacc;
                                    ">${feature}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="
                        background: rgba(0,0,0,0.3);
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 25px;
                    ">
                        <p style="color: ${statusColor}; font-style: italic; margin: 0;">
                            Status: ${projectData.status.replace('-', ' ').toUpperCase()}
                        </p>
                        ${projectData.eta ? `<p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">ETA: ${projectData.eta}</p>` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            padding: 15px 30px;
                            background: ${statusColor};
                            border: none;
                            border-radius: 10px;
                            color: #001122;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-size: 16px;
                        " onmouseover="this.style.background='#00cc88'" onmouseout="this.style.background='${statusColor}'">
                            Continue Exploring
                        </button>
                        
                        ${isComingSoon ? `
                            <button onclick="notifyWhenReady('${projectData.id}')" style="
                                padding: 15px 30px;
                                background: transparent;
                                border: 2px solid ${statusColor};
                                border-radius: 10px;
                                color: ${statusColor};
                                font-weight: bold;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-size: 16px;
                            " onmouseover="this.style.background='rgba(255,170,0,0.1)'" onmouseout="this.style.background='transparent'">
                                Notify When Ready
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes modalPulse {
                    0% { box-shadow: 0 0 40px rgba(0,255,170,0.4); }
                    100% { box-shadow: 0 0 60px rgba(0,255,170,0.6); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(modal);
            
            // Auto-remove after 15 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                }
            }, 15000);
        }
        
        function notifyWhenReady(projectId) {
            // Placeholder for notification system
            alert(`You'll be notified when ${projectId} is ready!`);
        }
        
        // Dynamic atmosphere
        let time = 0;
        function updateAtmosphere() {
            time += 0.01;
            const scene = document.querySelector('a-scene');
            if (scene && scene.hasLoaded) {
                // Subtle color shifts in the background
                const hue = Math.sin(time * 0.1) * 10 + 210; // Slight blue shifts
                const saturation = Math.sin(time * 0.05) * 10 + 80;
                scene.setAttribute('background', `color: hsl(${hue}, ${saturation}%, 8%)`);
            }
            requestAnimationFrame(updateAtmosphere);
        }
        updateAtmosphere();
    </script>
</body>
</html>